
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Understand ridge regression and cross-validation &#8212; Voxelwise modeling tutorials 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery-rendered-html.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Fit a ridge model with wordnet features" href="03_plot_wordnet_model.html" />
    <link rel="prev" title="Compute the explainable variance" href="01_plot_explainable_variance.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/flatmap.png" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">Voxelwise modeling tutorials</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=gallantlab&repo=voxelwise_tutorials&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Shortclips tutorial</a><ul>
      <li>Previous: <a href="01_plot_explainable_variance.html" title="previous chapter">Compute the explainable variance</a></li>
      <li>Next: <a href="03_plot_wordnet_model.html" title="next chapter">Fit a ridge model with wordnet features</a></li>
  </ul></li>
  </ul></li>
</ul>
</div><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Shortclips tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#vim-2-tutorial">Vim-2 tutorial</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../voxelwise_package.html">Helper Python package</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../voxelwise_modeling.html">References</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-shortclips-02-plot-ridge-regression-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="understand-ridge-regression-and-cross-validation">
<span id="sphx-glr-auto-examples-shortclips-02-plot-ridge-regression-py"></span><h1>Understand ridge regression and cross-validation<a class="headerlink" href="#understand-ridge-regression-and-cross-validation" title="Permalink to this headline">¶</a></h1>
<p>In future examples, we will model the fMRI responses using a regularized linear
regression known as <em>ridge regression</em>. This example explains why we use ridge
regression, and how to use cross-validation to select the appropriate
regularization hyper-parameter.</p>
<p>Linear regression is a method to model the relation between some input
variables <span class="math notranslate nohighlight">\(X \in \mathbb{R}^{(n \times p)}\)</span> (the features) and an output
variable <span class="math notranslate nohighlight">\(y \in \mathbb{R}^{n}\)</span> (the target). Specifically, linear
regression uses a vector of coefficient <span class="math notranslate nohighlight">\(w \in \mathbb{R}^{p}\)</span> to
predict the output</p>
<div class="math notranslate nohighlight">
\[\hat{y} = Xw\]</div>
<p>The model is considered accurate if the predictions <span class="math notranslate nohighlight">\(\hat{y}\)</span> are close
to the true output values <span class="math notranslate nohighlight">\(y\)</span>. Therefore,  a good linear regression model
is given by the vector <span class="math notranslate nohighlight">\(w\)</span> that minimizes the sum of squared errors:</p>
<div class="math notranslate nohighlight">
\[w = \arg\min_w ||Xw - y||^2\]</div>
<p>This is the simplest model for linear regression, and it is known as <em>ordinary
least squares</em> (OLS).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="section" id="ordinary-least-squares-ols">
<h2>Ordinary least squares (OLS)<a class="headerlink" href="#ordinary-least-squares-ols" title="Permalink to this headline">¶</a></h2>
<p>To illustrate OLS, let’s use a toy dataset with a single features <code class="docutils literal notranslate"><span class="pre">X[:,0]</span></code>.
On the plot below (left panel), each dot is a sample <code class="docutils literal notranslate"><span class="pre">(X[i,0],</span> <span class="pre">y[i])</span></code>, and
the linear regression model is the line <code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">X[:,0]</span> <span class="pre">*</span> <span class="pre">w[0]</span></code>. On each
sample, the error between the prediction and the true value is shown by a
gray line. By summing the squared errors over all samples, we get the squared
loss. Plotting the squared loss for every value of <code class="docutils literal notranslate"><span class="pre">w</span></code> leads to a parabola
(right panel).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">voxelwise_tutorials.regression_toy</span> <span class="kn">import</span> <span class="n">create_regression_toy</span>
<span class="kn">from</span> <span class="nn">voxelwise_tutorials.regression_toy</span> <span class="kn">import</span> <span class="n">plot_1d</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_regression_toy</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plot_1d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_001.png" />
<p>By varying the linear coefficient <code class="docutils literal notranslate"><span class="pre">w</span></code>, we can change the prediction
accuracy of the model, and thus the squared loss.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_1d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">])</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_002.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_1d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="mf">0.7</span><span class="p">])</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_003.png" />
<p>The linear coefficient leading to the minimum squared loss can be found
analytically with the formula:</p>
<div class="math notranslate nohighlight">
\[w = (X^\top X)^{-1}  X^\top y\]</div>
<p>This is the OLS solution.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">w_ols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">y</span><span class="p">)</span>

<span class="n">plot_1d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w_ols</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_004.png" />
<p>Linear regression can also be used on more than one feature. On the next toy
dataset, we will use two features <code class="docutils literal notranslate"><span class="pre">X[:,0]</span></code> and <code class="docutils literal notranslate"><span class="pre">X[:,1]</span></code>. The linear
regression model is a now plane. Here again, summing the squared errors over
all samples gives the squared loss.Plotting the squared loss for every value
of <code class="docutils literal notranslate"><span class="pre">w[0]</span></code> and <code class="docutils literal notranslate"><span class="pre">w[1]</span></code> leads to a 2D parabola (right panel).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">voxelwise_tutorials.regression_toy</span> <span class="kn">import</span> <span class="n">create_regression_toy</span>
<span class="kn">from</span> <span class="nn">voxelwise_tutorials.regression_toy</span> <span class="kn">import</span> <span class="n">plot_2d</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_regression_toy</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">plot_2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">show_noiseless</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_005.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">show_noiseless</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_006.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="n">show_noiseless</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_007.png" />
<p>Here again, the OLS solution can be found analytically with the same formula.
Note that the OLS solution is not equal to the ground-truth coefficients used
to generate the toy dataset (black cross), because we added some noise to the
target values <code class="docutils literal notranslate"><span class="pre">y</span></code>. We want the solution we find to be as close as possible
to the ground-truth coefficients, because it will allow the regression to
generalize correctly to new data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">w_ols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plot_2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w_ols</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_008.png" />
<p>The situation becomes more interesting when the features in <code class="docutils literal notranslate"><span class="pre">X</span></code> are
correlated. Here, we add a correlation between the first feature <code class="docutils literal notranslate"><span class="pre">X[:,</span> <span class="pre">0]</span></code>
and the second feature <code class="docutils literal notranslate"><span class="pre">X[:,</span> <span class="pre">1]</span></code>. With this correlation, the squared loss
function is no more isotropic, so the lines of equal loss are now ellipses
instead of circles. Thus, when starting from the OLS solution, moving <code class="docutils literal notranslate"><span class="pre">w</span></code>
toward the top left leads to a small change in the loss, whereas moving it
toward the top right leads to a large change in the loss. This anisotropy
makes the OLS solution less robust to noise in some particular directions
(deviating more from the ground-truth coefficients).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_regression_toy</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">correlation</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="n">w_ols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plot_2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w_ols</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_009.png" />
<p>The different robustness to noise can be understood mathematically by the
fact that the OLS solution requires inverting the matrix <span class="math notranslate nohighlight">\((X^T X)\)</span>. The
matrix inversion amounts to inverting the eigenvalues <span class="math notranslate nohighlight">\(\lambda_k\)</span> of
the matrix. When the features are highly correlated, some eigenvalues
<span class="math notranslate nohighlight">\(\lambda_k\)</span> are close to zero, and a small change in the features can
have a large effect on the inverse. Thus, having small eigenvalues reduces
the stability of the inversion. If the correlation is even higher, the
smallest eigenvalues get closer to zero, and the OLS solution becomes even
less stable.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_regression_toy</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">correlation</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>

<span class="n">w_ols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plot_2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w_ols</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_010.png" />
<p>The instability can become even more pronounced with larger number of
features, or with smaller numbers of samples.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_regression_toy</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">correlation</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>

<span class="n">w_ols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plot_2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w_ols</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_011.png" />
<p>When the number of features is larger than the number of samples, the linear
system becomes under-determined, which means that the OLS problem has an
infinite number of solutions, most of which do not generalize well to new
data.</p>
</div>
<div class="section" id="ridge-regression">
<h2>Ridge regression<a class="headerlink" href="#ridge-regression" title="Permalink to this headline">¶</a></h2>
<p>To solve the instability and under-determinacy issues of OLS, OLS can be
extended to <em>ridge regression</em>. Ridge regression considers a different
optimization problem:</p>
<div class="math notranslate nohighlight">
\[w = \arg\min_w ||Xw - y||^2 + \alpha ||w||^2\]</div>
<p>This optimization problem contains two terms: (i) a <em>data-fitting term</em>
<span class="math notranslate nohighlight">\(||Xw - y||^2\)</span>, which ensures the regression correctly fits the
training data; and (ii) a regularization term <span class="math notranslate nohighlight">\(\alpha||w||^2\)</span>, which
forces the coefficients <span class="math notranslate nohighlight">\(w\)</span> to be close to zero. The regularization
term increases the stability of the solution, at the cost of a bias toward
zero.</p>
<p>In the regularization term, <code class="docutils literal notranslate"><span class="pre">alpha</span></code> is a positive hyperparameter that
controls the regularization strength. With a smaller <code class="docutils literal notranslate"><span class="pre">alpha</span></code>, the solution
will be closer to the OLS solution, and with a larger <code class="docutils literal notranslate"><span class="pre">alpha</span></code>, the solution
will be further from the OLS solution and closer to the origin.</p>
<p>To illustrate this effect, the following plot shows the ridge solution for a
particular value of <code class="docutils literal notranslate"><span class="pre">alpha</span></code>. The black circle corresponds to the line of
equal regularization, whereas the blue ellipses are the lines of equal
squared loss.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_regression_toy</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">correlation</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="mi">23</span>
<span class="n">w_ridge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plot_2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w_ridge</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_012.png" />
<p>To understand why the regularization term makes the solution more robust to
noise, let’s consider the ridge solution. The ridge solution can be found
analytically with the formula:</p>
<div class="math notranslate nohighlight">
\[w = (X^\top X + \alpha I)^{-1}  X^\top y\]</div>
<p>where <code class="docutils literal notranslate"><span class="pre">I</span></code> is the identity matrix. In this formula, we can see that the
inverted matrix is now <span class="math notranslate nohighlight">\((X^\top X + \alpha I)\)</span>. Compared to OLS, the
additional term <span class="math notranslate nohighlight">\(\alpha I\)</span> adds a positive value <code class="docutils literal notranslate"><span class="pre">alpha</span></code> to all
eigenvalues <span class="math notranslate nohighlight">\(\lambda_k\)</span> of <span class="math notranslate nohighlight">\((X^\top X)\)</span> before the matrix
inversion. Inverting <span class="math notranslate nohighlight">\((\lambda_k + \alpha)\)</span> instead of
<span class="math notranslate nohighlight">\(\lambda_k\)</span> reduces the instability caused by small eigenvalues. This
explains why the ridge solution is more robust to noise than the OLS
solution.</p>
<p>In the following plots, we can see that even with a stronger correlation, the
ridge solution is still reasonably close to the noiseless ground truth, while
the OLS solution would be far off.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_regression_toy</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">correlation</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="mi">23</span>
<span class="n">w_ridge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plot_2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w_ridge</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_013.png" />
<p>Changing the regularization hyperparameter <span class="math notranslate nohighlight">\(\alpha\)</span> leads to another
ridge solution.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_regression_toy</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">correlation</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">w_ridge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plot_2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w_ridge</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_014.png" />
<p>Side note: For every <span class="math notranslate nohighlight">\(\alpha\)</span>, at the corresponding ridge solution, the
line of equal regularization and the line of equal loss are tangent. If the
two lines were crossing, one could improve the ridge solution by moving along
one line. It would improve one term while keeping the other term constant.</p>
</div>
<div class="section" id="hyperparameter-selection">
<h2>Hyperparameter selection<a class="headerlink" href="#hyperparameter-selection" title="Permalink to this headline">¶</a></h2>
<p>One issue with ridge regression is that the hyperparameter <span class="math notranslate nohighlight">\(\alpha\)</span> is
arbitrary. Different choices of hyperparameter lead to different models. To
compare these models, we cannot compare the ability to fit the training data,
because the best model would just be OLS (<span class="math notranslate nohighlight">\(alpha = 0\)</span>). Instead, we
want to compare the ability of each model to generalize to new data. To
estimate a model ability to generalize, we can compute its prediction
accuracy on a separate dataset that was not used during the model fitting
(i.e. not used to find the coefficients <span class="math notranslate nohighlight">\(w\)</span>).</p>
<p>To illustrate this idea, we can split the data into two subsets.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">voxelwise_tutorials.regression_toy</span> <span class="kn">import</span> <span class="n">create_regression_toy</span>
<span class="kn">from</span> <span class="nn">voxelwise_tutorials.regression_toy</span> <span class="kn">import</span> <span class="n">plot_kfold2</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_regression_toy</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plot_kfold2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_015.png" />
<p>Then, we can fit a model on each subset.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">plot_kfold2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<img alt="model 1, model 2" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_016.png" />
<p>And compute the prediction accuracy of each model on the other subset.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_kfold2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<img alt="model 1, model 2" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_017.png" />
<p>In this way, we can evaluate the ridge regression (fit with a specific
<span class="math notranslate nohighlight">\(\alpha\)</span>) on its ability to generalize to new data. If we do that for
different hyperparameter candidates <span class="math notranslate nohighlight">\(\alpha\)</span>, we can select the model
leading to the best out-of-set prediction accuracy.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">voxelwise_tutorials.regression_toy</span> <span class="kn">import</span> <span class="n">plot_cv_path</span>

<span class="n">noise</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_regression_toy</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="p">)</span>
<span class="n">plot_cv_path</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_018.png" />
<p>In the example above, the noise level is low, so the best hyperparameter
alpha is close to zero, and ridge regression is not much better than OLS.
However, if the dataset has more noise, a lower number of samples, or more
correlated features, the best hyperparameter can be higher. In this case,
ridge regression is better than OLS.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">noise</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_regression_toy</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="p">)</span>
<span class="n">plot_cv_path</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_019.png" />
<p>When the noise level is too high, the best hyperparameter can be the largest
on the grid. It either means that the grid is too small, or that the
regression does not find a predictive link between the features and the
target. In this case, the model with the lowest generalization error always
predict zero (<span class="math notranslate nohighlight">\(w=0\)</span>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">noise</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">create_regression_toy</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">noise</span><span class="p">)</span>
<span class="n">plot_cv_path</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<img alt="02 plot ridge regression" class="sphx-glr-single-img" src="../../_images/sphx_glr_02_plot_ridge_regression_020.png" />
<p>To summarize, to select the best hyperparameter <span class="math notranslate nohighlight">\(\alpha\)</span>, the standard
method is to perform a grid search:</p>
<blockquote>
<div><ul class="simple">
<li><p>Split the training set into two subsets: one subset used to fit the
models, and one subset to estimate the prediction accuracy (<em>validation
set</em>)</p></li>
<li><p>Define a number of hyperparameter candidates, for example [0.1, 1, 10,
100].</p></li>
<li><p>Fit a separate ridge model with each hyperparameter candidate
<span class="math notranslate nohighlight">\(\alpha\)</span>.</p></li>
<li><p>Compute the prediction accuracy on the validation set.</p></li>
<li><p>Select the hyperparameter candidate leading to the best validation
accuracy.</p></li>
</ul>
</div></blockquote>
<p>To make the grid search less sensitive to the choice of how the training data
was split, the process can be repeated for multiple splits. Then, the
different prediction accuracies can be averaged over splits before the
hyperparameter selection. Thus, the process is called a <em>cross-validation</em>.</p>
<p>Learn more about hyperparameter selection and cross-validation on the
<a class="reference external" href="https://scikit-learn.org/stable/modules/cross_validation.html">scikit-learn documentation</a>.</p>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  2.487 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-shortclips-02-plot-ridge-regression-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/2408f8bb7228659eb6fd173d262de0c6/02_plot_ridge_regression.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">02_plot_ridge_regression.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/b08b9a47ad8d2f06401017da1da914b2/02_plot_ridge_regression.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">02_plot_ridge_regression.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>
</div>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2020, Gallant lab.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/_auto_examples/shortclips/02_plot_ridge_regression.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>