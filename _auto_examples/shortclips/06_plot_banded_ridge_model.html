
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Fit a banded ridge model with both wordnet and motion energy features &#8212; Voxelwise modeling tutorials 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Extract motion energy features from the stimuli" href="07_extract_motion_energy.html" />
    <link rel="prev" title="Fit a ridge model with motion energy features" href="05_plot_motion_energy_model.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/flatmap.png" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">Voxelwise modeling tutorials</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=gallantlab&repo=voxelwise_tutorials&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Shortclips tutorial</a><ul>
  <li><a href="index.html">Shortclips tutorial</a><ul>
      <li>Previous: <a href="05_plot_motion_energy_model.html" title="previous chapter">Fit a ridge model with motion energy features</a></li>
      <li>Next: <a href="07_extract_motion_energy.html" title="next chapter">Extract motion energy features from the stimuli</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Shortclips tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html#vim-2-tutorial">Vim-2 tutorial</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../voxelwise_modeling.html">Voxelwise modeling framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../voxelwise_package.html">Helper Python package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-shortclips-06-plot-banded-ridge-model-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="fit-a-banded-ridge-model-with-both-wordnet-and-motion-energy-features">
<span id="sphx-glr-auto-examples-shortclips-06-plot-banded-ridge-model-py"></span><h1>Fit a banded ridge model with both wordnet and motion energy features<a class="headerlink" href="#fit-a-banded-ridge-model-with-both-wordnet-and-motion-energy-features" title="Permalink to this heading">¶</a></h1>
<p>In this example, we model the fMRI responses with a <cite>banded ridge regression</cite>,
with two different feature spaces: motion energy and wordnet categories.</p>
<p><em>Banded ridge regression:</em> Since the relative scaling of both feature spaces is
unknown, we use two regularization hyperparameters (one per feature space) in a
model called banded ridge regression <a class="footnote-reference brackets" href="#id3" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>. Just like with ridge regression, we
optimize the hyperparameters over cross-validation. An efficient implementation
of this model is available in the <a class="reference external" href="https://github.com/gallantlab/himalaya">himalaya</a> package.</p>
<p><em>Running time:</em> This example is more computationally intensive than the
previous examples. With a GPU backend, model fitting takes around 6 minutes.
With a CPU backend, it can last 10 times more.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<section id="path-of-the-data-directory">
<h2>Path of the data directory<a class="headerlink" href="#path-of-the-data-directory" title="Permalink to this heading">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">voxelwise_tutorials.io</span> <span class="kn">import</span> <span class="n">get_data_home</span>
<span class="n">directory</span> <span class="o">=</span> <span class="n">get_data_home</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;shortclips&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/home/jlg/mvdoc/voxelwise_tutorials_data/shortclips
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># modify to use another subject</span>
<span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;S01&quot;</span>
</pre></div>
</div>
</section>
<section id="load-the-data">
<h2>Load the data<a class="headerlink" href="#load-the-data" title="Permalink to this heading">¶</a></h2>
<p>As in the previous examples, we first load the fMRI responses, which are our
regression targets.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">voxelwise_tutorials.io</span> <span class="kn">import</span> <span class="n">load_hdf5_array</span>

<span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;responses&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_responses.hdf&quot;</span><span class="p">)</span>
<span class="n">Y_train</span> <span class="o">=</span> <span class="n">load_hdf5_array</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Y_train&quot;</span><span class="p">)</span>
<span class="n">Y_test</span> <span class="o">=</span> <span class="n">load_hdf5_array</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;Y_test&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(n_samples_train, n_voxels) =&quot;</span><span class="p">,</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(n_repeats, n_samples_test, n_voxels) =&quot;</span><span class="p">,</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>(n_samples_train, n_voxels) = (3600, 84038)
(n_repeats, n_samples_test, n_voxels) = (10, 270, 84038)
</pre></div>
</div>
<p>We also compute the explainable variance, to exclude voxels with low
explainable variance from the fit, and speed up the model fitting.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">voxelwise_tutorials.utils</span> <span class="kn">import</span> <span class="n">explainable_variance</span>
<span class="n">ev</span> <span class="o">=</span> <span class="n">explainable_variance</span><span class="p">(</span><span class="n">Y_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(n_voxels,) =&quot;</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">ev</span> <span class="o">&gt;</span> <span class="mf">0.1</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(n_voxels_mask,) =&quot;</span><span class="p">,</span> <span class="n">ev</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>(n_voxels,) = (84038,)
(n_voxels_mask,) = (6849,)
</pre></div>
</div>
<p>We average the test repeats, to remove the non-repeatable part of fMRI
responses.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Y_test</span> <span class="o">=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(n_samples_test, n_voxels) =&quot;</span><span class="p">,</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>(n_samples_test, n_voxels) = (270, 84038)
</pre></div>
</div>
<p>We fill potential NaN (not-a-number) values with zeros.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">Y_train</span><span class="p">)</span>
<span class="n">Y_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">Y_test</span><span class="p">)</span>
</pre></div>
</div>
<p>And we make sure the targets are centered.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Y_train</span> <span class="o">-=</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Y_test</span> <span class="o">-=</span> <span class="n">Y_test</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Then we load both feature spaces, that are going to be used for the
linear regression model.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;wordnet&quot;</span><span class="p">,</span> <span class="s2">&quot;motion_energy&quot;</span><span class="p">]</span>

<span class="n">Xs_train</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Xs_test</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">n_features_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">feature_space</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">:</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feature_space</span><span class="si">}</span><span class="s2">.hdf&quot;</span><span class="p">)</span>
    <span class="n">Xi_train</span> <span class="o">=</span> <span class="n">load_hdf5_array</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;X_train&quot;</span><span class="p">)</span>
    <span class="n">Xi_test</span> <span class="o">=</span> <span class="n">load_hdf5_array</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;X_test&quot;</span><span class="p">)</span>

    <span class="n">Xs_train</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Xi_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">))</span>
    <span class="n">Xs_test</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Xi_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">))</span>
    <span class="n">n_features_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Xi_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># concatenate the feature spaces</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">Xs_train</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">Xs_test</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(n_samples_train, n_features_total) =&quot;</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(n_samples_test, n_features_total) =&quot;</span><span class="p">,</span> <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[n_features_wordnet, n_features_motion_energy] =&quot;</span><span class="p">,</span> <span class="n">n_features_list</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>(n_samples_train, n_features_total) = (3600, 8260)
(n_samples_test, n_features_total) = (270, 8260)
[n_features_wordnet, n_features_motion_energy] = [1705, 6555]
</pre></div>
</div>
</section>
<section id="define-the-cross-validation-scheme">
<h2>Define the cross-validation scheme<a class="headerlink" href="#define-the-cross-validation-scheme" title="Permalink to this heading">¶</a></h2>
<p>We define again a leave-one-run-out cross-validation split scheme.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">check_cv</span>
<span class="kn">from</span> <span class="nn">voxelwise_tutorials.utils</span> <span class="kn">import</span> <span class="n">generate_leave_one_run_out</span>

<span class="c1"># indice of first sample of each run</span>
<span class="n">run_onsets</span> <span class="o">=</span> <span class="n">load_hdf5_array</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;run_onsets&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">run_onsets</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[   0  300  600  900 1200 1500 1800 2100 2400 2700 3000 3300]
</pre></div>
</div>
<p>We define a cross-validation splitter, compatible with <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> API.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_samples_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">generate_leave_one_run_out</span><span class="p">(</span><span class="n">n_samples_train</span><span class="p">,</span> <span class="n">run_onsets</span><span class="p">)</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">check_cv</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span>  <span class="c1"># copy the cross-validation splitter into a reusable list</span>
</pre></div>
</div>
</section>
<section id="define-the-model">
<h2>Define the model<a class="headerlink" href="#define-the-model" title="Permalink to this heading">¶</a></h2>
<p>The model pipeline contains similar steps than the pipeline from previous
examples. We remove the mean of each feature with a <code class="docutils literal notranslate"><span class="pre">StandardScaler</span></code>,
and add delays with a <code class="docutils literal notranslate"><span class="pre">Delayer</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">voxelwise_tutorials.delayer</span> <span class="kn">import</span> <span class="n">Delayer</span>
<span class="kn">from</span> <span class="nn">himalaya.backend</span> <span class="kn">import</span> <span class="n">set_backend</span>
<span class="n">backend</span> <span class="o">=</span> <span class="n">set_backend</span><span class="p">(</span><span class="s2">&quot;torch_cuda&quot;</span><span class="p">,</span> <span class="n">on_error</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To fit the banded ridge model, we use <code class="docutils literal notranslate"><span class="pre">himalaya</span></code>’s
<code class="docutils literal notranslate"><span class="pre">MultipleKernelRidgeCV</span></code> model, with a separate linear kernel per feature
space. Similarly to <code class="docutils literal notranslate"><span class="pre">KernelRidgeCV</span></code>, the model optimizes the
hyperparameters over cross-validation. However, while <code class="docutils literal notranslate"><span class="pre">KernelRidgeCV</span></code> has
to optimize only one hyperparameter (<code class="docutils literal notranslate"><span class="pre">alpha</span></code>), <code class="docutils literal notranslate"><span class="pre">MultipleKernelRidgeCV</span></code>
has to optimize <code class="docutils literal notranslate"><span class="pre">m</span></code> hyperparameters, where <code class="docutils literal notranslate"><span class="pre">m</span></code> is the number of feature
spaces (here <code class="docutils literal notranslate"><span class="pre">m</span> <span class="pre">=</span> <span class="pre">2</span></code>). To do so, the model implements two different
solvers, one using hyperparameter random search, and one using hyperparameter
gradient descent. For large number of targets, we recommend using the
random-search solver.</p>
<p>The class takes a number of common parameters during initialization, such as
<code class="docutils literal notranslate"><span class="pre">kernels</span></code>, or <code class="docutils literal notranslate"><span class="pre">solver</span></code>. Since the solver parameters vary depending on the
solver used, they are passed as a <code class="docutils literal notranslate"><span class="pre">solver_params</span></code> dictionary.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">himalaya.kernel_ridge</span> <span class="kn">import</span> <span class="n">MultipleKernelRidgeCV</span>

<span class="c1"># Here we will use the &quot;random_search&quot; solver.</span>
<span class="n">solver</span> <span class="o">=</span> <span class="s2">&quot;random_search&quot;</span>

<span class="c1"># We can check its specific parameters in the function docstring:</span>
<span class="n">solver_function</span> <span class="o">=</span> <span class="n">MultipleKernelRidgeCV</span><span class="o">.</span><span class="n">ALL_SOLVERS</span><span class="p">[</span><span class="n">solver</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Docstring of the function </span><span class="si">%s</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="n">solver_function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">solver_function</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Docstring of the function solve_multiple_kernel_ridge_random_search:
Solve multiple kernel ridge regression using random search.

    Parameters
    ----------
    Ks : array of shape (n_kernels, n_samples, n_samples)
        Input kernels.
    Y : array of shape (n_samples, n_targets)
        Target data.
    n_iter : int, or array of shape (n_iter, n_kernels)
        Number of kernel weights combination to search.
        If an array is given, the solver uses it as the list of kernel weights
        to try, instead of sampling from a Dirichlet distribution. Examples:
          - `n_iter=np.eye(n_kernels)` implement a winner-take-all strategy
            over kernels.
          - `n_iter=np.ones((1, n_kernels))/n_kernels` solves a (standard)
            kernel ridge regression.
    concentration : float, or list of float
        Concentration parameters of the Dirichlet distribution.
        If a list, iteratively cycle through the list.
        Not used if n_iter is an array.
    alphas : float or array of shape (n_alphas, )
        Range of ridge regularization parameter.
    score_func : callable
        Function used to compute the score of predictions versus Y.
    cv : int or scikit-learn splitter
        Cross-validation splitter. If an int, KFold is used.
    fit_intercept : boolean
        Whether to fit an intercept. If False, Ks should be centered
        (see KernelCenterer), and Y must be zero-mean over samples.
        Only available if return_weights == &#39;dual&#39;.
    return_weights : None, &#39;primal&#39;, or &#39;dual&#39;
        Whether to refit on the entire dataset and return the weights.
    Xs : array of shape (n_kernels, n_samples, n_features) or None
        Necessary if return_weights == &#39;primal&#39;.
    local_alpha : bool
        If True, alphas are selected per target, else shared over all targets.
    jitter_alphas : bool
        If True, alphas range is slightly jittered for each gamma.
    random_state : int, or None
        Random generator seed. Use an int for deterministic search.
    n_targets_batch : int or None
        Size of the batch for over targets during cross-validation.
        Used for memory reasons. If None, uses all n_targets at once.
    n_targets_batch_refit : int or None
        Size of the batch for over targets during refit.
        Used for memory reasons. If None, uses all n_targets at once.
    n_alphas_batch : int or None
        Size of the batch for over alphas. Used for memory reasons.
        If None, uses all n_alphas at once.
    progress_bar : bool
        If True, display a progress bar over gammas.
    Ks_in_cpu : bool
        If True, keep Ks in CPU memory to limit GPU memory (slower).
        This feature is not available through the scikit-learn API.
    conservative : bool
        If True, when selecting the hyperparameter alpha, take the largest one
        that is less than one standard deviation away from the best.
        If False, take the best.
    Y_in_cpu : bool
        If True, keep the target values ``Y`` in CPU memory (slower).
    diagonalize_method : str in {&quot;eigh&quot;, &quot;svd&quot;}
        Method used to diagonalize the kernel.
    return_alphas : bool
        If True, return the best alpha value for each target.

    Returns
    -------
    deltas : array of shape (n_kernels, n_targets)
        Best log kernel weights for each target.
    refit_weights : array or None
        Refit regression weights on the entire dataset, using selected best
        hyperparameters. Refit weights are always stored on CPU memory.
        If return_weights == &#39;primal&#39;, shape is (n_features, n_targets),
        if return_weights == &#39;dual&#39;, shape is (n_samples, n_targets),
        else, None.
    cv_scores : array of shape (n_iter, n_targets)
        Cross-validation scores per iteration, averaged over splits, for the
        best alpha. Cross-validation scores will always be on CPU memory.
    best_alphas : array of shape (n_targets, )
        Best alpha value per target. Only returned if return_alphas is True.
    intercept : array of shape (n_targets,)
        Intercept. Only returned when fit_intercept is True.
</pre></div>
</div>
<p>The hyperparameter random-search solver separates the hyperparameters into a
shared regularization <code class="docutils literal notranslate"><span class="pre">alpha</span></code> and a vector of positive kernel weights which
sum to one. This separation of hyperparameters allows to explore efficiently
a large grid of values for <code class="docutils literal notranslate"><span class="pre">alpha</span></code> for each sampled kernel weights vector.</p>
<p>We use <em>20</em> random-search iterations to have a reasonably fast example. To
have better results, especially for larger number of feature spaces, one
might need more iterations. (Note that there is currently no stopping
criterion in the random-search method.)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_iter</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>Batch parameters, used to reduce the necessary GPU memory. A larger value
will be a bit faster, but the solver might crash if it is out of memory.
Optimal values depend on the size of your dataset.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_targets_batch</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">n_alphas_batch</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">n_targets_batch_refit</span> <span class="o">=</span> <span class="mi">200</span>
</pre></div>
</div>
<p>We put all these parameters in a dictionary <code class="docutils literal notranslate"><span class="pre">solver_params</span></code>, and define
the main estimator <code class="docutils literal notranslate"><span class="pre">MultipleKernelRidgeCV</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">solver_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">n_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span> <span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">,</span>
                     <span class="n">n_targets_batch</span><span class="o">=</span><span class="n">n_targets_batch</span><span class="p">,</span>
                     <span class="n">n_alphas_batch</span><span class="o">=</span><span class="n">n_alphas_batch</span><span class="p">,</span>
                     <span class="n">n_targets_batch_refit</span><span class="o">=</span><span class="n">n_targets_batch_refit</span><span class="p">)</span>

<span class="n">mkr_model</span> <span class="o">=</span> <span class="n">MultipleKernelRidgeCV</span><span class="p">(</span><span class="n">kernels</span><span class="o">=</span><span class="s2">&quot;precomputed&quot;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>
                                  <span class="n">solver_params</span><span class="o">=</span><span class="n">solver_params</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">)</span>
</pre></div>
</div>
<p>We need a bit more work than in previous examples before defining the full
pipeline, since the banded ridge model requires <cite>multiple</cite> precomputed
kernels, one for each feature space. To compute them, we use the
<code class="docutils literal notranslate"><span class="pre">ColumnKernelizer</span></code>, which can create multiple kernels from different
column of your features array. <code class="docutils literal notranslate"><span class="pre">ColumnKernelizer</span></code> works similarly to
<code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code>’s <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code>, but instead of returning a
concatenation of transformed features, it returns a stack of kernels,
as required in <code class="docutils literal notranslate"><span class="pre">MultipleKernelRidgeCV(kernels=&quot;precomputed&quot;)</span></code>.</p>
<p>First, we create a different <code class="docutils literal notranslate"><span class="pre">Kernelizer</span></code> for each feature space.
Here we use a linear kernel for all feature spaces, but <code class="docutils literal notranslate"><span class="pre">ColumnKernelizer</span></code>
accepts any <code class="docutils literal notranslate"><span class="pre">Kernelizer</span></code>, or <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> ending with a
<code class="docutils literal notranslate"><span class="pre">Kernelizer</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">himalaya.kernel_ridge</span> <span class="kn">import</span> <span class="n">Kernelizer</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">set_config</span>
<span class="n">set_config</span><span class="p">(</span><span class="n">display</span><span class="o">=</span><span class="s1">&#39;diagram&#39;</span><span class="p">)</span>  <span class="c1"># requires scikit-learn 0.23</span>

<span class="n">preprocess_pipeline</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">StandardScaler</span><span class="p">(</span><span class="n">with_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_std</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Delayer</span><span class="p">(</span><span class="n">delays</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span>
    <span class="n">Kernelizer</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">preprocess_pipeline</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<style>#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 {color: black;background-color: white;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 pre{padding: 0;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-toggleable {background-color: white;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-estimator:hover {background-color: #d4ebff;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-item {z-index: 1;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-parallel::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-parallel-item {display: flex;flex-direction: column;position: relative;background-color: white;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-parallel-item:only-child::after {width: 0;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;position: relative;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-label label {font-family: monospace;font-weight: bold;background-color: white;display: inline-block;line-height: 1.2em;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-label-container {position: relative;z-index: 2;text-align: center;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669 div.sk-text-repr-fallback {display: none;}</style><div id="sk-9f5f072a-44b3-4573-bc4c-3a3d762f0669" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[(&#x27;standardscaler&#x27;, StandardScaler(with_std=False)),
                (&#x27;delayer&#x27;, Delayer(delays=[1, 2, 3, 4])),
                (&#x27;kernelizer&#x27;, Kernelizer())])</pre><b>Please rerun this cell to show the HTML repr or trust the notebook.</b></div><div class="sk-container" hidden><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="3db29d71-28d5-46f9-979c-a30cfb9a5c2e" type="checkbox" ><label for="3db29d71-28d5-46f9-979c-a30cfb9a5c2e" class="sk-toggleable__label sk-toggleable__label-arrow">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[(&#x27;standardscaler&#x27;, StandardScaler(with_std=False)),
                (&#x27;delayer&#x27;, Delayer(delays=[1, 2, 3, 4])),
                (&#x27;kernelizer&#x27;, Kernelizer())])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="e6f87b98-6250-416d-9a35-c21d44211e64" type="checkbox" ><label for="e6f87b98-6250-416d-9a35-c21d44211e64" class="sk-toggleable__label sk-toggleable__label-arrow">StandardScaler</label><div class="sk-toggleable__content"><pre>StandardScaler(with_std=False)</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="179f233e-fbd0-4301-909c-38f793769b5e" type="checkbox" ><label for="179f233e-fbd0-4301-909c-38f793769b5e" class="sk-toggleable__label sk-toggleable__label-arrow">Delayer</label><div class="sk-toggleable__content"><pre>Delayer(delays=[1, 2, 3, 4])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="1f3d3fff-7220-49d8-973a-f45d8f47b22b" type="checkbox" ><label for="1f3d3fff-7220-49d8-973a-f45d8f47b22b" class="sk-toggleable__label sk-toggleable__label-arrow">Kernelizer</label><div class="sk-toggleable__content"><pre>Kernelizer()</pre></div></div></div></div></div></div></div>
</div>
<br />
<br /><p>The column kernelizer applies a different pipeline on each selection of
features, here defined with <code class="docutils literal notranslate"><span class="pre">slices</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">himalaya.kernel_ridge</span> <span class="kn">import</span> <span class="n">ColumnKernelizer</span>

<span class="c1"># Find the start and end of each feature space in the concatenated ``X_train``.</span>
<span class="n">start_and_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">n_features_list</span><span class="p">)])</span>
<span class="n">slices</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_and_end</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">start_and_end</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="p">]</span>
<span class="n">slices</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[slice(0, 1705, None), slice(1705, 8260, None)]
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kernelizers_tuples</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">preprocess_pipeline</span><span class="p">,</span> <span class="n">slice_</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">slice_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">slices</span><span class="p">)]</span>
<span class="n">column_kernelizer</span> <span class="o">=</span> <span class="n">ColumnKernelizer</span><span class="p">(</span><span class="n">kernelizers_tuples</span><span class="p">)</span>
<span class="n">column_kernelizer</span>

<span class="c1"># (Note that ``ColumnKernelizer`` has a parameter ``n_jobs`` to parallelize</span>
<span class="c1"># each ``Kernelizer``, yet such parallelism does not work with GPU arrays.)</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<style>#sk-1e863a01-c102-4e50-bf47-8c0c928683ad {color: black;background-color: white;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad pre{padding: 0;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-toggleable {background-color: white;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-estimator:hover {background-color: #d4ebff;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-item {z-index: 1;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-parallel::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-parallel-item {display: flex;flex-direction: column;position: relative;background-color: white;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-parallel-item:only-child::after {width: 0;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;position: relative;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-label label {font-family: monospace;font-weight: bold;background-color: white;display: inline-block;line-height: 1.2em;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-label-container {position: relative;z-index: 2;text-align: center;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-1e863a01-c102-4e50-bf47-8c0c928683ad div.sk-text-repr-fallback {display: none;}</style><div id="sk-1e863a01-c102-4e50-bf47-8c0c928683ad" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>ColumnKernelizer(transformers=[(&#x27;wordnet&#x27;,
                                Pipeline(steps=[(&#x27;standardscaler&#x27;,
                                                 StandardScaler(with_std=False)),
                                                (&#x27;delayer&#x27;,
                                                 Delayer(delays=[1, 2, 3, 4])),
                                                (&#x27;kernelizer&#x27;, Kernelizer())]),
                                slice(0, 1705, None)),
                               (&#x27;motion_energy&#x27;,
                                Pipeline(steps=[(&#x27;standardscaler&#x27;,
                                                 StandardScaler(with_std=False)),
                                                (&#x27;delayer&#x27;,
                                                 Delayer(delays=[1, 2, 3, 4])),
                                                (&#x27;kernelizer&#x27;, Kernelizer())]),
                                slice(1705, 8260, None))])</pre><b>Please rerun this cell to show the HTML repr or trust the notebook.</b></div><div class="sk-container" hidden><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="d2d7632c-0810-4728-96b0-7503cc6983d0" type="checkbox" ><label for="d2d7632c-0810-4728-96b0-7503cc6983d0" class="sk-toggleable__label sk-toggleable__label-arrow">ColumnKernelizer</label><div class="sk-toggleable__content"><pre>ColumnKernelizer(transformers=[(&#x27;wordnet&#x27;,
                                Pipeline(steps=[(&#x27;standardscaler&#x27;,
                                                 StandardScaler(with_std=False)),
                                                (&#x27;delayer&#x27;,
                                                 Delayer(delays=[1, 2, 3, 4])),
                                                (&#x27;kernelizer&#x27;, Kernelizer())]),
                                slice(0, 1705, None)),
                               (&#x27;motion_energy&#x27;,
                                Pipeline(steps=[(&#x27;standardscaler&#x27;,
                                                 StandardScaler(with_std=False)),
                                                (&#x27;delayer&#x27;,
                                                 Delayer(delays=[1, 2, 3, 4])),
                                                (&#x27;kernelizer&#x27;, Kernelizer())]),
                                slice(1705, 8260, None))])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="b71eb695-2ae5-4535-bd6c-3ede45879d08" type="checkbox" ><label for="b71eb695-2ae5-4535-bd6c-3ede45879d08" class="sk-toggleable__label sk-toggleable__label-arrow">wordnet</label><div class="sk-toggleable__content"><pre>slice(0, 1705, None)</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="e77bc24e-c131-4b10-9c0d-1ad3362b66cd" type="checkbox" ><label for="e77bc24e-c131-4b10-9c0d-1ad3362b66cd" class="sk-toggleable__label sk-toggleable__label-arrow">StandardScaler</label><div class="sk-toggleable__content"><pre>StandardScaler(with_std=False)</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="089628b4-b8cd-4200-9cdc-1036f7f8606f" type="checkbox" ><label for="089628b4-b8cd-4200-9cdc-1036f7f8606f" class="sk-toggleable__label sk-toggleable__label-arrow">Delayer</label><div class="sk-toggleable__content"><pre>Delayer(delays=[1, 2, 3, 4])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="76c7ecd4-ac37-4198-9692-115714c01520" type="checkbox" ><label for="76c7ecd4-ac37-4198-9692-115714c01520" class="sk-toggleable__label sk-toggleable__label-arrow">Kernelizer</label><div class="sk-toggleable__content"><pre>Kernelizer()</pre></div></div></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="fe66065a-93d7-4545-b359-bafb07e855cd" type="checkbox" ><label for="fe66065a-93d7-4545-b359-bafb07e855cd" class="sk-toggleable__label sk-toggleable__label-arrow">motion_energy</label><div class="sk-toggleable__content"><pre>slice(1705, 8260, None)</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="bb666579-090f-4612-ac10-e82bf97c903e" type="checkbox" ><label for="bb666579-090f-4612-ac10-e82bf97c903e" class="sk-toggleable__label sk-toggleable__label-arrow">StandardScaler</label><div class="sk-toggleable__content"><pre>StandardScaler(with_std=False)</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="2cf5fdd3-88f4-4523-8ddc-2301a0ca187d" type="checkbox" ><label for="2cf5fdd3-88f4-4523-8ddc-2301a0ca187d" class="sk-toggleable__label sk-toggleable__label-arrow">Delayer</label><div class="sk-toggleable__content"><pre>Delayer(delays=[1, 2, 3, 4])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="58b62c87-e37b-4e2c-a017-1577242ae62c" type="checkbox" ><label for="58b62c87-e37b-4e2c-a017-1577242ae62c" class="sk-toggleable__label sk-toggleable__label-arrow">Kernelizer</label><div class="sk-toggleable__content"><pre>Kernelizer()</pre></div></div></div></div></div></div></div></div></div></div></div></div>
</div>
<br />
<br /><p>Then we can define the model pipeline.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">column_kernelizer</span><span class="p">,</span>
    <span class="n">mkr_model</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">pipeline</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<style>#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 {color: black;background-color: white;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 pre{padding: 0;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-toggleable {background-color: white;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-estimator:hover {background-color: #d4ebff;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-item {z-index: 1;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-parallel::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-parallel-item {display: flex;flex-direction: column;position: relative;background-color: white;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-parallel-item:only-child::after {width: 0;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;position: relative;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-label label {font-family: monospace;font-weight: bold;background-color: white;display: inline-block;line-height: 1.2em;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-label-container {position: relative;z-index: 2;text-align: center;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-412f2ed5-52fe-40e3-9487-021ebaacd512 div.sk-text-repr-fallback {display: none;}</style><div id="sk-412f2ed5-52fe-40e3-9487-021ebaacd512" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[(&#x27;columnkernelizer&#x27;,
                 ColumnKernelizer(transformers=[(&#x27;wordnet&#x27;,
                                                 Pipeline(steps=[(&#x27;standardscaler&#x27;,
                                                                  StandardScaler(with_std=False)),
                                                                 (&#x27;delayer&#x27;,
                                                                  Delayer(delays=[1,
                                                                                  2,
                                                                                  3,
                                                                                  4])),
                                                                 (&#x27;kernelizer&#x27;,
                                                                  Kernelizer())]),
                                                 slice(0, 1705, None)),
                                                (&#x27;motion_energy&#x27;,
                                                 Pipeline(steps=[(&#x27;standardscaler&#x27;,
                                                                  StandardScaler(with_std=False)),
                                                                 (&#x27;delayer&#x27;,
                                                                  Delayer(delays=[1,
                                                                                  2,
                                                                                  3,
                                                                                  4]...
                 MultipleKernelRidgeCV(cv=_CVIterableWrapper(cv=[(array([   0,    1, ..., 3598, 3599]), array([3000, 3001, ..., 3298, 3299])), (array([   0,    1, ..., 3598, 3599]), array([2700, 2701, ..., 2998, 2999])), (array([   0,    1, ..., 3598, 3599]), array([ 900,  901, ..., 1198, 1199])), (array([   0,    1, ..., 3598, 3599]), array([1200, 1201, ...,...  1, ..., 298, 299])), (array([   0,    1, ..., 3298, 3299]), array([3300, 3301, ..., 3598, 3599]))]),
                                       kernels=&#x27;precomputed&#x27;,
                                       solver_params={&#x27;alphas&#x27;: array([1.e+01, 1.e+02, 1.e+03, 1.e+04, 1.e+05, 1.e+06, 1.e+07, 1.e+08,
       1.e+09, 1.e+10, 1.e+11, 1.e+12, 1.e+13, 1.e+14, 1.e+15, 1.e+16,
       1.e+17, 1.e+18, 1.e+19, 1.e+20]),
                                                      &#x27;n_alphas_batch&#x27;: 5,
                                                      &#x27;n_iter&#x27;: 20,
                                                      &#x27;n_targets_batch&#x27;: 200,
                                                      &#x27;n_targets_batch_refit&#x27;: 200}))])</pre><b>Please rerun this cell to show the HTML repr or trust the notebook.</b></div><div class="sk-container" hidden><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="3b44924d-15ee-4647-9644-cb0e2a57cab0" type="checkbox" ><label for="3b44924d-15ee-4647-9644-cb0e2a57cab0" class="sk-toggleable__label sk-toggleable__label-arrow">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[(&#x27;columnkernelizer&#x27;,
                 ColumnKernelizer(transformers=[(&#x27;wordnet&#x27;,
                                                 Pipeline(steps=[(&#x27;standardscaler&#x27;,
                                                                  StandardScaler(with_std=False)),
                                                                 (&#x27;delayer&#x27;,
                                                                  Delayer(delays=[1,
                                                                                  2,
                                                                                  3,
                                                                                  4])),
                                                                 (&#x27;kernelizer&#x27;,
                                                                  Kernelizer())]),
                                                 slice(0, 1705, None)),
                                                (&#x27;motion_energy&#x27;,
                                                 Pipeline(steps=[(&#x27;standardscaler&#x27;,
                                                                  StandardScaler(with_std=False)),
                                                                 (&#x27;delayer&#x27;,
                                                                  Delayer(delays=[1,
                                                                                  2,
                                                                                  3,
                                                                                  4]...
                 MultipleKernelRidgeCV(cv=_CVIterableWrapper(cv=[(array([   0,    1, ..., 3598, 3599]), array([3000, 3001, ..., 3298, 3299])), (array([   0,    1, ..., 3598, 3599]), array([2700, 2701, ..., 2998, 2999])), (array([   0,    1, ..., 3598, 3599]), array([ 900,  901, ..., 1198, 1199])), (array([   0,    1, ..., 3598, 3599]), array([1200, 1201, ...,...  1, ..., 298, 299])), (array([   0,    1, ..., 3298, 3299]), array([3300, 3301, ..., 3598, 3599]))]),
                                       kernels=&#x27;precomputed&#x27;,
                                       solver_params={&#x27;alphas&#x27;: array([1.e+01, 1.e+02, 1.e+03, 1.e+04, 1.e+05, 1.e+06, 1.e+07, 1.e+08,
       1.e+09, 1.e+10, 1.e+11, 1.e+12, 1.e+13, 1.e+14, 1.e+15, 1.e+16,
       1.e+17, 1.e+18, 1.e+19, 1.e+20]),
                                                      &#x27;n_alphas_batch&#x27;: 5,
                                                      &#x27;n_iter&#x27;: 20,
                                                      &#x27;n_targets_batch&#x27;: 200,
                                                      &#x27;n_targets_batch_refit&#x27;: 200}))])</pre></div></div></div><div class="sk-serial"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="935961d3-8e56-4a25-9cee-26c229f056e8" type="checkbox" ><label for="935961d3-8e56-4a25-9cee-26c229f056e8" class="sk-toggleable__label sk-toggleable__label-arrow">columnkernelizer: ColumnKernelizer</label><div class="sk-toggleable__content"><pre>ColumnKernelizer(transformers=[(&#x27;wordnet&#x27;,
                                Pipeline(steps=[(&#x27;standardscaler&#x27;,
                                                 StandardScaler(with_std=False)),
                                                (&#x27;delayer&#x27;,
                                                 Delayer(delays=[1, 2, 3, 4])),
                                                (&#x27;kernelizer&#x27;, Kernelizer())]),
                                slice(0, 1705, None)),
                               (&#x27;motion_energy&#x27;,
                                Pipeline(steps=[(&#x27;standardscaler&#x27;,
                                                 StandardScaler(with_std=False)),
                                                (&#x27;delayer&#x27;,
                                                 Delayer(delays=[1, 2, 3, 4])),
                                                (&#x27;kernelizer&#x27;, Kernelizer())]),
                                slice(1705, 8260, None))])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="a69e101f-488f-40c5-bc13-2b8d18810816" type="checkbox" ><label for="a69e101f-488f-40c5-bc13-2b8d18810816" class="sk-toggleable__label sk-toggleable__label-arrow">wordnet</label><div class="sk-toggleable__content"><pre>slice(0, 1705, None)</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="0b504202-f0a2-4d1a-81d5-c0e967601ff0" type="checkbox" ><label for="0b504202-f0a2-4d1a-81d5-c0e967601ff0" class="sk-toggleable__label sk-toggleable__label-arrow">StandardScaler</label><div class="sk-toggleable__content"><pre>StandardScaler(with_std=False)</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="6f6b264e-68c2-4fd0-81c3-1c930ab0058a" type="checkbox" ><label for="6f6b264e-68c2-4fd0-81c3-1c930ab0058a" class="sk-toggleable__label sk-toggleable__label-arrow">Delayer</label><div class="sk-toggleable__content"><pre>Delayer(delays=[1, 2, 3, 4])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="7801146a-9722-4af9-854f-af71957ad0a0" type="checkbox" ><label for="7801146a-9722-4af9-854f-af71957ad0a0" class="sk-toggleable__label sk-toggleable__label-arrow">Kernelizer</label><div class="sk-toggleable__content"><pre>Kernelizer()</pre></div></div></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="432b3ebe-6f84-49e3-9168-02e57a94f0f6" type="checkbox" ><label for="432b3ebe-6f84-49e3-9168-02e57a94f0f6" class="sk-toggleable__label sk-toggleable__label-arrow">motion_energy</label><div class="sk-toggleable__content"><pre>slice(1705, 8260, None)</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="45667457-ffa2-4971-85b0-9618eb1958b0" type="checkbox" ><label for="45667457-ffa2-4971-85b0-9618eb1958b0" class="sk-toggleable__label sk-toggleable__label-arrow">StandardScaler</label><div class="sk-toggleable__content"><pre>StandardScaler(with_std=False)</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="283970e6-1fd5-4ef2-85e6-dc1ab8dd5c07" type="checkbox" ><label for="283970e6-1fd5-4ef2-85e6-dc1ab8dd5c07" class="sk-toggleable__label sk-toggleable__label-arrow">Delayer</label><div class="sk-toggleable__content"><pre>Delayer(delays=[1, 2, 3, 4])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="f2043cf0-eb5f-4a8e-992d-e392f748da8f" type="checkbox" ><label for="f2043cf0-eb5f-4a8e-992d-e392f748da8f" class="sk-toggleable__label sk-toggleable__label-arrow">Kernelizer</label><div class="sk-toggleable__content"><pre>Kernelizer()</pre></div></div></div></div></div></div></div></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="750e2b50-7265-4898-8ab4-96c644072b2d" type="checkbox" ><label for="750e2b50-7265-4898-8ab4-96c644072b2d" class="sk-toggleable__label sk-toggleable__label-arrow">MultipleKernelRidgeCV</label><div class="sk-toggleable__content"><pre>MultipleKernelRidgeCV(cv=_CVIterableWrapper(cv=[(array([   0,    1, ..., 3598, 3599]), array([3000, 3001, ..., 3298, 3299])), (array([   0,    1, ..., 3598, 3599]), array([2700, 2701, ..., 2998, 2999])), (array([   0,    1, ..., 3598, 3599]), array([ 900,  901, ..., 1198, 1199])), (array([   0,    1, ..., 3598, 3599]), array([1200, 1201, ...,...  1, ..., 298, 299])), (array([   0,    1, ..., 3298, 3299]), array([3300, 3301, ..., 3598, 3599]))]),
                      kernels=&#x27;precomputed&#x27;,
                      solver_params={&#x27;alphas&#x27;: array([1.e+01, 1.e+02, 1.e+03, 1.e+04, 1.e+05, 1.e+06, 1.e+07, 1.e+08,
       1.e+09, 1.e+10, 1.e+11, 1.e+12, 1.e+13, 1.e+14, 1.e+15, 1.e+16,
       1.e+17, 1.e+18, 1.e+19, 1.e+20]),
                                     &#x27;n_alphas_batch&#x27;: 5, &#x27;n_iter&#x27;: 20,
                                     &#x27;n_targets_batch&#x27;: 200,
                                     &#x27;n_targets_batch_refit&#x27;: 200})</pre></div></div></div></div></div></div></div>
</div>
<br />
<br /></section>
<section id="fit-the-model">
<h2>Fit the model<a class="headerlink" href="#fit-the-model" title="Permalink to this heading">¶</a></h2>
<p>We fit on the train set, and score on the test set.</p>
<p>To speed up the fit and to limit the memory peak in Colab, we only fit on
voxels with explainable variance above 0.1.</p>
<p>With a GPU backend, the fitting of this model takes around 6 minutes. With a
CPU backend, it can last 10 times more.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">])</span>

<span class="n">scores_mask</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">])</span>
<span class="n">scores_mask</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">scores_mask</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(n_voxels_mask,) =&quot;</span><span class="p">,</span> <span class="n">scores_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Then we extend the scores to all voxels, giving a score of zero to unfitted</span>
<span class="c1"># voxels.</span>
<span class="n">n_voxels</span> <span class="o">=</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_voxels</span><span class="p">)</span>
<span class="n">scores</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores_mask</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(n_voxels,) =&quot;</span><span class="p">,</span> <span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[                                        ] 0% | 0.00 sec | 20 random sampling with cv |
[..                                      ] 5% | 4.40 sec | 20 random sampling with cv |
[....                                    ] 10% | 8.58 sec | 20 random sampling with cv |
[......                                  ] 15% | 12.75 sec | 20 random sampling with cv |
[........                                ] 20% | 16.89 sec | 20 random sampling with cv |
[..........                              ] 25% | 21.10 sec | 20 random sampling with cv |
[............                            ] 30% | 25.24 sec | 20 random sampling with cv |
[..............                          ] 35% | 29.41 sec | 20 random sampling with cv |
[................                        ] 40% | 33.59 sec | 20 random sampling with cv |
[..................                      ] 45% | 37.78 sec | 20 random sampling with cv |
[....................                    ] 50% | 41.93 sec | 20 random sampling with cv |
[......................                  ] 55% | 46.06 sec | 20 random sampling with cv |
[........................                ] 60% | 50.22 sec | 20 random sampling with cv |
[..........................              ] 65% | 54.36 sec | 20 random sampling with cv |
[............................            ] 70% | 58.53 sec | 20 random sampling with cv |
[..............................          ] 75% | 62.68 sec | 20 random sampling with cv |
[................................        ] 80% | 66.84 sec | 20 random sampling with cv |
[..................................      ] 85% | 71.00 sec | 20 random sampling with cv |
[....................................    ] 90% | 75.15 sec | 20 random sampling with cv |
[......................................  ] 95% | 79.29 sec | 20 random sampling with cv |
[........................................] 100% | 83.45 sec | 20 random sampling with cv |
(n_voxels_mask,) = (6849,)
(n_voxels,) = (84038,)
</pre></div>
</div>
</section>
<section id="compare-with-a-ridge-model">
<h2>Compare with a ridge model<a class="headerlink" href="#compare-with-a-ridge-model" title="Permalink to this heading">¶</a></h2>
<p>We can compare with a baseline model, which does not use one hyperparameter
per feature space, but instead shares the same hyperparameter for all feature
spaces.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">himalaya.kernel_ridge</span> <span class="kn">import</span> <span class="n">KernelRidgeCV</span>

<span class="n">pipeline_baseline</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">StandardScaler</span><span class="p">(</span><span class="n">with_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_std</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Delayer</span><span class="p">(</span><span class="n">delays</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span>
    <span class="n">KernelRidgeCV</span><span class="p">(</span>
        <span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
        <span class="n">solver_params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">n_targets_batch</span><span class="o">=</span><span class="n">n_targets_batch</span><span class="p">,</span>
                           <span class="n">n_alphas_batch</span><span class="o">=</span><span class="n">n_alphas_batch</span><span class="p">,</span>
                           <span class="n">n_targets_batch_refit</span><span class="o">=</span><span class="n">n_targets_batch_refit</span><span class="p">)),</span>
<span class="p">)</span>
<span class="n">pipeline_baseline</span>
</pre></div>
</div>
<div class="output_subarea output_html rendered_html output_result">
<style>#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 {color: black;background-color: white;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 pre{padding: 0;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-toggleable {background-color: white;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-estimator:hover {background-color: #d4ebff;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-item {z-index: 1;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-parallel::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 2em;bottom: 0;left: 50%;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-parallel-item {display: flex;flex-direction: column;position: relative;background-color: white;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-parallel-item:only-child::after {width: 0;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;position: relative;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-label label {font-family: monospace;font-weight: bold;background-color: white;display: inline-block;line-height: 1.2em;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-label-container {position: relative;z-index: 2;text-align: center;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-8cc7641f-7226-439b-af48-8f4af9b70aa6 div.sk-text-repr-fallback {display: none;}</style><div id="sk-8cc7641f-7226-439b-af48-8f4af9b70aa6" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[(&#x27;standardscaler&#x27;, StandardScaler(with_std=False)),
                (&#x27;delayer&#x27;, Delayer(delays=[1, 2, 3, 4])),
                (&#x27;kernelridgecv&#x27;,
                 KernelRidgeCV(alphas=array([1.e+01, 1.e+02, 1.e+03, 1.e+04, 1.e+05, 1.e+06, 1.e+07, 1.e+08,
       1.e+09, 1.e+10, 1.e+11, 1.e+12, 1.e+13, 1.e+14, 1.e+15, 1.e+16,
       1.e+17, 1.e+18, 1.e+19, 1.e+20]),
                               cv=_CVIterableWrapper(cv=[(array([   0,    1, ..., 3598, 3599]), array...299])), (array([   0,    1, ..., 3598, 3599]), array([2700, 2701, ..., 2998, 2999])), (array([   0,    1, ..., 3598, 3599]), array([ 900,  901, ..., 1198, 1199])), (array([   0,    1, ..., 3598, 3599]), array([1200, 1201, ...,...  1, ..., 298, 299])), (array([   0,    1, ..., 3298, 3299]), array([3300, 3301, ..., 3598, 3599]))]),
                               solver_params={&#x27;n_alphas_batch&#x27;: 5,
                                              &#x27;n_targets_batch&#x27;: 200,
                                              &#x27;n_targets_batch_refit&#x27;: 200}))])</pre><b>Please rerun this cell to show the HTML repr or trust the notebook.</b></div><div class="sk-container" hidden><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="3529103a-6d48-4131-940b-f9dc6c138b1c" type="checkbox" ><label for="3529103a-6d48-4131-940b-f9dc6c138b1c" class="sk-toggleable__label sk-toggleable__label-arrow">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[(&#x27;standardscaler&#x27;, StandardScaler(with_std=False)),
                (&#x27;delayer&#x27;, Delayer(delays=[1, 2, 3, 4])),
                (&#x27;kernelridgecv&#x27;,
                 KernelRidgeCV(alphas=array([1.e+01, 1.e+02, 1.e+03, 1.e+04, 1.e+05, 1.e+06, 1.e+07, 1.e+08,
       1.e+09, 1.e+10, 1.e+11, 1.e+12, 1.e+13, 1.e+14, 1.e+15, 1.e+16,
       1.e+17, 1.e+18, 1.e+19, 1.e+20]),
                               cv=_CVIterableWrapper(cv=[(array([   0,    1, ..., 3598, 3599]), array...299])), (array([   0,    1, ..., 3598, 3599]), array([2700, 2701, ..., 2998, 2999])), (array([   0,    1, ..., 3598, 3599]), array([ 900,  901, ..., 1198, 1199])), (array([   0,    1, ..., 3598, 3599]), array([1200, 1201, ...,...  1, ..., 298, 299])), (array([   0,    1, ..., 3298, 3299]), array([3300, 3301, ..., 3598, 3599]))]),
                               solver_params={&#x27;n_alphas_batch&#x27;: 5,
                                              &#x27;n_targets_batch&#x27;: 200,
                                              &#x27;n_targets_batch_refit&#x27;: 200}))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="854719be-2d86-4794-8698-5d3e29c89801" type="checkbox" ><label for="854719be-2d86-4794-8698-5d3e29c89801" class="sk-toggleable__label sk-toggleable__label-arrow">StandardScaler</label><div class="sk-toggleable__content"><pre>StandardScaler(with_std=False)</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="9eb165d7-3883-4ad0-82e7-02f43cb3e219" type="checkbox" ><label for="9eb165d7-3883-4ad0-82e7-02f43cb3e219" class="sk-toggleable__label sk-toggleable__label-arrow">Delayer</label><div class="sk-toggleable__content"><pre>Delayer(delays=[1, 2, 3, 4])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="f6d01104-9e1b-49be-af0f-fd8cdb0e8c1f" type="checkbox" ><label for="f6d01104-9e1b-49be-af0f-fd8cdb0e8c1f" class="sk-toggleable__label sk-toggleable__label-arrow">KernelRidgeCV</label><div class="sk-toggleable__content"><pre>KernelRidgeCV(alphas=array([1.e+01, 1.e+02, 1.e+03, 1.e+04, 1.e+05, 1.e+06, 1.e+07, 1.e+08,
       1.e+09, 1.e+10, 1.e+11, 1.e+12, 1.e+13, 1.e+14, 1.e+15, 1.e+16,
       1.e+17, 1.e+18, 1.e+19, 1.e+20]),
              cv=_CVIterableWrapper(cv=[(array([   0,    1, ..., 3598, 3599]), array([3000, 3001, ..., 3298, 3299])), (array([   0,    1, ..., 3598, 3599]), array([2700, 2701, ..., 2998, 2999])), (array([   0,    1, ..., 3598, 3599]), array([ 900,  901, ..., 1198, 1199])), (array([   0,    1, ..., 3598, 3599]), array([1200, 1201, ...,...  1, ..., 298, 299])), (array([   0,    1, ..., 3298, 3299]), array([3300, 3301, ..., 3598, 3599]))]),
              solver_params={&#x27;n_alphas_batch&#x27;: 5, &#x27;n_targets_batch&#x27;: 200,
                             &#x27;n_targets_batch_refit&#x27;: 200})</pre></div></div></div></div></div></div></div>
</div>
<br />
<br /><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline_baseline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">])</span>
<span class="n">scores_baseline_mask</span> <span class="o">=</span> <span class="n">pipeline_baseline</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">])</span>
<span class="n">scores_baseline_mask</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">scores_baseline_mask</span><span class="p">)</span>

<span class="c1"># extend to unfitted voxels</span>
<span class="n">n_voxels</span> <span class="o">=</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">scores_baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_voxels</span><span class="p">)</span>
<span class="n">scores_baseline</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores_baseline_mask</span>
</pre></div>
</div>
<p>Here we plot the comparison of model prediction accuracies with a 2D
histogram. All 70k voxels are represented in this histogram, where the
diagonal corresponds to identical model prediction accuracy for both models.
A distibution deviating from the diagonal means that one model has better
predictive performance than the other.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">voxelwise_tutorials.viz</span> <span class="kn">import</span> <span class="n">plot_hist2d</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_hist2d</span><span class="p">(</span><span class="n">scores_baseline</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Generalization R2 scores&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;KernelRidgeCV&#39;</span><span class="p">,</span>
       <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;MultipleKernelRidgeCV&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_06_plot_banded_ridge_model_001.png" srcset="../../_images/sphx_glr_06_plot_banded_ridge_model_001.png" alt="Generalization R2 scores" class = "sphx-glr-single-img"/><p>We see that the banded ridge model (<code class="docutils literal notranslate"><span class="pre">MultipleKernelRidgeCV</span></code>) outperforms
the ridge model (<code class="docutils literal notranslate"><span class="pre">KernelRidegeCV</span></code>). Indeed, banded ridge regression is able
to find the optimal scalings of each feature space, independently on each
voxel. Banded ridge regression is thus able to perform a soft selection
between the available feature spaces, based on the cross-validation
performances.</p>
</section>
<section id="plot-the-banded-ridge-split">
<h2>Plot the banded ridge split<a class="headerlink" href="#plot-the-banded-ridge-split" title="Permalink to this heading">¶</a></h2>
<p>On top of better prediction accuracy, banded ridge regression also gives a
way to disentangle the contribution of the two feature spaces. To do so, we
take the kernel weights and the ridge (dual) weights corresponding to each
feature space, and use them to compute the prediction from each feature space
separately.</p>
<div class="math notranslate nohighlight">
\[\hat{y} = \sum_i^m \hat{y}_i = \sum_i^m \gamma_i K_i \hat{w}\]</div>
<p>Then, we use these split predictions to compute split <span class="math notranslate nohighlight">\(\tilde{R}^2_i\)</span>
scores. These scores are corrected so that their sum is equal to the
<span class="math notranslate nohighlight">\(R^2\)</span> score of the full prediction <span class="math notranslate nohighlight">\(\hat{y}\)</span>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">himalaya.scoring</span> <span class="kn">import</span> <span class="n">r2_score_split</span>

<span class="n">Y_test_pred_split</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">split_scores_mask</span> <span class="o">=</span> <span class="n">r2_score_split</span><span class="p">(</span><span class="n">Y_test</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">],</span> <span class="n">Y_test_pred_split</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(n_kernels, n_samples_test, n_voxels_mask) =&quot;</span><span class="p">,</span> <span class="n">Y_test_pred_split</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(n_kernels, n_voxels_mask) =&quot;</span><span class="p">,</span> <span class="n">split_scores_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># extend to unfitted voxels</span>
<span class="n">n_kernels</span> <span class="o">=</span> <span class="n">split_scores_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">n_voxels</span> <span class="o">=</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">split_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_kernels</span><span class="p">,</span> <span class="n">n_voxels</span><span class="p">))</span>
<span class="n">split_scores</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">split_scores_mask</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(n_kernels, n_voxels) =&quot;</span><span class="p">,</span> <span class="n">split_scores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>(n_kernels, n_samples_test, n_voxels_mask) = torch.Size([2, 270, 6849])
(n_kernels, n_voxels_mask) = torch.Size([2, 6849])
(n_kernels, n_voxels) = (2, 84038)
</pre></div>
</div>
<p>We can then plot the split scores on a flatmap with a 2D colormap.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">voxelwise_tutorials.viz</span> <span class="kn">import</span> <span class="n">plot_2d_flatmap_from_mapper</span>

<span class="n">mapper_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;mappers&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">_mappers.hdf&quot;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_2d_flatmap_from_mapper</span><span class="p">(</span><span class="n">split_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">split_scores</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">mapper_file</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">vmin2</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">vmax2</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label_1</span><span class="o">=</span><span class="n">feature_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">label_2</span><span class="o">=</span><span class="n">feature_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_06_plot_banded_ridge_model_002.png" srcset="../../_images/sphx_glr_06_plot_banded_ridge_model_002.png" alt="06 plot banded ridge model" class = "sphx-glr-single-img"/><p>The blue regions are better predicted by the motion-energy features, the
orange regions are better predicted by the wordnet features, and the white
regions are well predicted by both feature spaces.</p>
<p>Compared to the last figure of the previous example, we see that most white
regions have been replaced by either blue or orange regions. The banded ridge
regression disentangled the two feature spaces in voxels where both feature
spaces had good prediction accuracy (see previous example). For example,
motion-energy features predict brain activity in early visual cortex, while
wordnet features predict in semantic visual areas. For more discussions about
these results, we refer the reader to the original publication <a class="footnote-reference brackets" href="#id3" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading">¶</a></h2>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id3" role="note">
<span class="label"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id1">1</a>,<a role="doc-backlink" href="#id2">2</a>)</span>
<p>Nunez-Elizalde, A. O., Huth, A. G., &amp; Gallant, J. L. (2019).
Voxelwise encoding models with non-spherical multivariate normal priors.
Neuroimage, 197, 482-492.</p>
</aside>
</aside>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 1 minutes  48.497 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-shortclips-06-plot-banded-ridge-model-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/4054db03678e854defc49f2d4f95aaae/06_plot_banded_ridge_model.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">06_plot_banded_ridge_model.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/2aa089bd2296ce0b80f6e909697a5069/06_plot_banded_ridge_model.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">06_plot_banded_ridge_model.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2023, Gallant lab.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/_auto_examples/shortclips/06_plot_banded_ridge_model.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>